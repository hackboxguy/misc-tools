#!/bin/bash
# ==============================================================================
# Raspberry Pi 4 Kernel Cross-Compilation Configuration
# ==============================================================================
# This file contains shared configuration variables for all build scripts.
# Source this file in each script: source "$(dirname "$0")/config.env"
# ==============================================================================

# ------------------------------------------------------------------------------
# Directory Configuration (MUST BE FIRST - other vars depend on BUILD_BASE)
# ------------------------------------------------------------------------------
# Base directory for all build operations
export BUILD_BASE="${BUILD_BASE:-$HOME/rpi-kernel-build}"

# ------------------------------------------------------------------------------
# Target Configuration
# ------------------------------------------------------------------------------
# Raspberry Pi 4 (64-bit) kernel identifier
export KERNEL=kernel8

# Target architecture
export ARCH=arm64

# Cross-compiler prefix (Arch Linux package: aarch64-linux-gnu-gcc)
export CROSS_COMPILE=aarch64-linux-gnu-

# Kernel defconfig for Pi 4 64-bit (bcm2711 is the SoC on Pi 4)
export DEFCONFIG=bcm2711_defconfig

# Optional: Path to custom kernel config from your Pi
# Copy from Pi: /boot/config-6.12.47+rpt-rpi-v8
# If set, this will be used instead of DEFCONFIG
export CUSTOM_KERNEL_CONFIG="${CUSTOM_KERNEL_CONFIG:-$BUILD_BASE/config-6.12.47+rpt-rpi-v8}"

# ------------------------------------------------------------------------------
# Path Configuration
# ------------------------------------------------------------------------------
# Kernel source directory
export KERNEL_SRC="$BUILD_BASE/linux"

# Output directory for compiled modules/overlays
export BUILD_OUTPUT="$BUILD_BASE/output"

# Directory containing custom driver packages
export DRIVER_PKG_DIR="${DRIVER_PKG_DIR:-$BUILD_BASE/br-wrapper/package}"

# ------------------------------------------------------------------------------
# Kernel Source Configuration
# ------------------------------------------------------------------------------
# Raspberry Pi kernel repository
export KERNEL_REPO="https://github.com/raspberrypi/linux.git"

# Branch to use (rpi-6.12.y for kernel 6.12.x series)
# Your target: 6.12.47+rpt-rpi-v8
#
# To find exact tag for your kernel version, after cloning run:
#   cd ~/rpi-kernel-build/linux
#   git fetch --tags
#   git tag -l "*6.12.47*"
#
# If exact tag exists (e.g., stable_20250916), you can set:
#   export KERNEL_BRANCH="stable_20250916"
export KERNEL_BRANCH="rpi-6.12.y"

# Shallow clone depth (1 = latest commit only, saves time and space)
export CLONE_DEPTH=1

# ------------------------------------------------------------------------------
# Raspberry Pi Image Configuration
# ------------------------------------------------------------------------------
# Path to the Raspberry Pi OS image file
export RPI_IMAGE="${RPI_IMAGE:-$BUILD_BASE/2025-10-01-raspios-bookworm-arm64-lite-base-micropanel-01-01-custom-01-02.img}"

# Mount points for the image partitions
export MNT_BOOT="/mnt/rpi-boot"
export MNT_ROOT="/mnt/rpi-root"

# ------------------------------------------------------------------------------
# Build Configuration
# ------------------------------------------------------------------------------
# Number of parallel jobs (auto-detect CPU cores)
export JOBS=$(nproc)

# Enable verbose output (set to 1 for debugging)
export VERBOSE="${VERBOSE:-0}"

# ------------------------------------------------------------------------------
# Custom Driver Configuration
# ------------------------------------------------------------------------------
# hh983-serializer driver
export HH983_SRC="$DRIVER_PKG_DIR/hh983-serializer/src"
export HH983_DTS="$DRIVER_PKG_DIR/hh983-serializer/src/hh983-serializer-overlay.dts"

# himax-touch driver
export HIMAX_SRC="$DRIVER_PKG_DIR/himax-touch/src"
export HIMAX_DTS="$DRIVER_PKG_DIR/himax-touch/dts/himax-touch-overlay.dts"

# ------------------------------------------------------------------------------
# Helper Functions
# ------------------------------------------------------------------------------
log_info() {
    echo -e "\033[1;34m[INFO]\033[0m $*"
}

log_success() {
    echo -e "\033[1;32m[SUCCESS]\033[0m $*"
}

log_warn() {
    echo -e "\033[1;33m[WARNING]\033[0m $*"
}

log_error() {
    echo -e "\033[1;31m[ERROR]\033[0m $*"
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root (use sudo)"
        exit 1
    fi
}

check_not_root() {
    if [[ $EUID -eq 0 ]]; then
        log_error "This script should NOT be run as root"
        exit 1
    fi
}
